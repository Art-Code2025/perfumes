<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug - Perfum SA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .loading { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .product-card { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>API Debug Tool - Perfum SA</h1>
        
        <div class="test-section">
            <h3>معلومات البيئة</h3>
            <div id="env-info"></div>
        </div>
        
        <div class="test-section">
            <h3>اختبار الاتصال بـ API</h3>
            <button onclick="testApiConnection()">اختبار الاتصال</button>
            <div id="api-test-result"></div>
        </div>
        
        <div class="test-section">
            <h3>اختبار جلب جميع المنتجات</h3>
            <button onclick="testGetAllProducts()">جلب جميع المنتجات</button>
            <div id="products-result"></div>
        </div>
        
        <div class="test-section">
            <h3>اختبار البحث عن منتج محدد</h3>
            <input type="text" id="product-id" placeholder="أدخل معرف المنتج" value="43a0veCDOJ4jGmpbcWgg">
            <button onclick="testGetProductById()">البحث عن المنتج</button>
            <div id="product-result"></div>
        </div>
        
        <div class="test-section">
            <h3>اختبار البحث بالـ Slug</h3>
            <button onclick="testSearchBySlug()">البحث بالـ Slug في جميع المنتجات</button>
            <div id="slug-result"></div>
        </div>
    </div>

    <script>
        // Display environment info
        document.getElementById('env-info').innerHTML = `
            <strong>الموقع:</strong> ${window.location.href}<br>
            <strong>الهوست:</strong> ${window.location.hostname}<br>
            <strong>البورت:</strong> ${window.location.port || 'غير محدد'}<br>
            <strong>البروتوكول:</strong> ${window.location.protocol}<br>
            <strong>المسار:</strong> ${window.location.pathname}
        `;

        // API Configuration
        const getApiBaseUrl = () => {
            const isDevelopment = window.location.hostname === 'localhost';
            return isDevelopment ? 
                'http://localhost:8888/.netlify/functions' : 
                '/.netlify/functions';
        };

        const buildApiUrl = (endpoint) => {
            const baseUrl = getApiBaseUrl();
            const cleanEndpoint = endpoint.startsWith('/') ? endpoint.slice(1) : endpoint;
            return `${baseUrl}/${cleanEndpoint}`;
        };

        // Test API connection
        async function testApiConnection() {
            const resultDiv = document.getElementById('api-test-result');
            resultDiv.className = 'loading';
            resultDiv.innerHTML = 'جاري اختبار الاتصال...';

            try {
                const url = buildApiUrl('products');
                console.log('Testing API URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('API Response:', response);

                if (response.ok) {
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `
                        <strong>✅ الاتصال ناجح!</strong><br>
                        <strong>الحالة:</strong> ${response.status} ${response.statusText}<br>
                        <strong>URL:</strong> ${url}
                    `;
                } else {
                    resultDiv.className = 'error';
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <strong>❌ فشل الاتصال</strong><br>
                        <strong>الحالة:</strong> ${response.status} ${response.statusText}<br>
                        <strong>الخطأ:</strong> ${errorText}<br>
                        <strong>URL:</strong> ${url}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <strong>❌ خطأ في الاتصال</strong><br>
                    <strong>الخطأ:</strong> ${error.message}<br>
                    <strong>URL:</strong> ${buildApiUrl('products')}
                `;
                console.error('API Connection Error:', error);
            }
        }

        // Test get all products
        async function testGetAllProducts() {
            const resultDiv = document.getElementById('products-result');
            resultDiv.className = 'loading';
            resultDiv.innerHTML = 'جاري جلب المنتجات...';

            try {
                const url = buildApiUrl('products');
                const response = await fetch(url);
                
                if (response.ok) {
                    const products = await response.json();
                    resultDiv.className = 'success';
                    
                    let html = `<strong>✅ تم جلب ${products.length} منتج:</strong><br><br>`;
                    
                    products.slice(0, 5).forEach(product => {
                        html += `
                            <div class="product-card">
                                <strong>الاسم:</strong> ${product.name}<br>
                                <strong>المعرف:</strong> ${product.id}<br>
                                <strong>الـ Slug:</strong> ${product.slug || 'غير موجود'}<br>
                                <strong>السعر:</strong> ${product.price} ريال
                            </div>
                        `;
                    });
                    
                    if (products.length > 5) {
                        html += `<p>... و ${products.length - 5} منتج آخر</p>`;
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.className = 'error';
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <strong>❌ فشل في جلب المنتجات</strong><br>
                        <strong>الحالة:</strong> ${response.status}<br>
                        <strong>الخطأ:</strong> ${errorText}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <strong>❌ خطأ في جلب المنتجات</strong><br>
                    <strong>الخطأ:</strong> ${error.message}
                `;
                console.error('Get Products Error:', error);
            }
        }

        // Test get product by ID
        async function testGetProductById() {
            const productId = document.getElementById('product-id').value;
            const resultDiv = document.getElementById('product-result');
            
            if (!productId) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = 'يرجى إدخال معرف المنتج';
                return;
            }

            resultDiv.className = 'loading';
            resultDiv.innerHTML = `جاري البحث عن المنتج: ${productId}...`;

            try {
                const url = buildApiUrl(`products/${productId}`);
                console.log('Fetching product from:', url);
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const product = await response.json();
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `
                        <strong>✅ تم العثور على المنتج:</strong><br>
                        <div class="product-card">
                            <strong>الاسم:</strong> ${product.name}<br>
                            <strong>المعرف:</strong> ${product.id}<br>
                            <strong>الوصف:</strong> ${product.description}<br>
                            <strong>السعر:</strong> ${product.price} ريال<br>
                            <strong>المخزون:</strong> ${product.stock}<br>
                            <strong>الصورة:</strong> ${product.mainImage ? 'موجودة' : 'غير موجودة'}
                        </div>
                        <details>
                            <summary>البيانات الكاملة (JSON)</summary>
                            <pre>${JSON.stringify(product, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    resultDiv.className = 'error';
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <strong>❌ لم يتم العثور على المنتج</strong><br>
                        <strong>الحالة:</strong> ${response.status}<br>
                        <strong>الخطأ:</strong> ${errorText}<br>
                        <strong>URL:</strong> ${url}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <strong>❌ خطأ في البحث عن المنتج</strong><br>
                    <strong>الخطأ:</strong> ${error.message}
                `;
                console.error('Get Product Error:', error);
            }
        }

        // Test search by slug in all products
        async function testSearchBySlug() {
            const slug = '43a0veCDOJ4jGmpbcWgg';
            const resultDiv = document.getElementById('slug-result');
            
            resultDiv.className = 'loading';
            resultDiv.innerHTML = `جاري البحث عن المنتج بالـ slug: ${slug}...`;

            try {
                // First get all products
                const url = buildApiUrl('products');
                const response = await fetch(url);
                
                if (response.ok) {
                    const products = await response.json();
                    console.log('All products for slug search:', products);
                    
                    // Search for product by slug
                    const product = products.find(p => {
                        // Check direct slug match
                        if (p.slug === slug) return true;
                        
                        // Check ID match
                        if (p.id?.toString() === slug || p._id?.toString() === slug) return true;
                        
                        // Generate slug from name
                        const generatedSlug = p.name
                            ?.toLowerCase()
                            .replace(/[^\w\s-]/g, '')
                            .replace(/\s+/g, '-')
                            .trim();
                        
                        return generatedSlug === slug;
                    });
                    
                    if (product) {
                        resultDiv.className = 'success';
                        resultDiv.innerHTML = `
                            <strong>✅ تم العثور على المنتج بالـ slug:</strong><br>
                            <div class="product-card">
                                <strong>الاسم:</strong> ${product.name}<br>
                                <strong>المعرف:</strong> ${product.id}<br>
                                <strong>الـ Slug:</strong> ${product.slug || 'مولد من الاسم'}<br>
                                <strong>الوصف:</strong> ${product.description}<br>
                                <strong>السعر:</strong> ${product.price} ريال
                            </div>
                        `;
                    } else {
                        resultDiv.className = 'error';
                        resultDiv.innerHTML = `
                            <strong>❌ لم يتم العثور على منتج بالـ slug: ${slug}</strong><br>
                            <strong>عدد المنتجات المتاحة:</strong> ${products.length}<br>
                            <details>
                                <summary>أول 3 منتجات متاحة</summary>
                                <pre>${JSON.stringify(products.slice(0, 3), null, 2)}</pre>
                            </details>
                        `;
                    }
                } else {
                    resultDiv.className = 'error';
                    const errorText = await response.text();
                    resultDiv.innerHTML = `
                        <strong>❌ فشل في جلب المنتجات للبحث</strong><br>
                        <strong>الحالة:</strong> ${response.status}<br>
                        <strong>الخطأ:</strong> ${errorText}
                    `;
                }
            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <strong>❌ خطأ في البحث بالـ slug</strong><br>
                    <strong>الخطأ:</strong> ${error.message}
                `;
                console.error('Slug Search Error:', error);
            }
        }

        // Auto-run basic tests on load
        window.onload = function() {
            console.log('Debug page loaded, running basic tests...');
            testApiConnection();
        };
    </script>
</body>
</html> 